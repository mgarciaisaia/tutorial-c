
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Aprendiendo Assembler para entender C - C para Operativos</title>
  <meta name="author" content="mgarciaisaia">

  
  <meta name="description" content="Este post es mi traducción del post Understanding C by learning assembly de David Albert, del blog de Hacker School. La traducción fue hecha con el &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mgarciaisaia.github.io/tutorial-c/blog/2015/02/19/aprendiendo-assembler-para-entender-c">
  <link href="/tutorial-c/favicon.png" rel="icon">
  <link href="/tutorial-c/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/tutorial-c/atom.xml" rel="alternate" title="C para Operativos" type="application/atom+xml">
  <script src="/tutorial-c/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/tutorial-c/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

<link rel="stylesheet" href="/tutorial-c/stylesheets/gh-fork-ribbon.css" />
<!--[if IE]>
<link rel="stylesheet" href="/tutorial-c/stylesheets/gh-fork-ribbon.ie.css" />
<![endif]-->

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-59960325-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/tutorial-c/">C para Operativos</a></h1>
  
    <h2>Aprendiendo C para una cursada feliz de Sistemas Operativos</h2>
  
  </hgroup>

<div class="github-fork-ribbon-wrapper right">
	<div class="github-fork-ribbon">
		<a href="https://github.com/mgarciaisaia/octopress">¡Forkeame!</a>
	</div>
</div>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/tutorial-c/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:mgarciaisaia.github.io/tutorial-c" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/tutorial-c/">Blog</a></li>
  <li><a href="/tutorial-c/blog/archives">Archives</a></li>
  <li><a href="/tutorial-c/lo-c-tutto/">Lo C Tutto</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Aprendiendo Assembler Para Entender C</h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-02-19T19:10:00-03:00" pubdate data-updated="true">Feb 19<span>th</span>, 2015</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p><em>Este post es mi traducción del post <a href="https://www.hackerschool.com/blog/7-understanding-c-by-learning-assembly">Understanding C by learning assembly</a> de <a href="https://github.com/davidbalbert">David Albert</a>, del blog de <a href="https://www.hackerschool.com/">Hacker School</a>. La traducción fue hecha con el permiso de Hacker School, y obviamente todos los derechos sobre el post original les pertenecen a ellos.
Cualquier error o sugerencia sobre la traducción es más que bienvenida.</em></p>

<p>La última vez, <a href="https://github.com/happy4crazy">Alan</a> mostró cómo usar <a href="https://www.hackerschool.com/blog/5-learning-c-with-gdb">GDB como una herramienta para aprender C</a>. Hoy quiero ir un paso más allá y usar GDB para ayudarnos a entender assembler, también.</p>

<p>Las capas de abstracción son grandes herramientas para construir cosas, pero a veces pueden interponerse en el aprendizaje. Mi objetivo en este post es convencerte de que para aprender C rigurosamente, también necesitamos entender el código assembler que nuestro compilador de C genera. Voy a hacer esto mostrándote cómo desensamblar y leer un programa simple con GDB, y después vamos a usar GDB y nuestro conocimiento de assembler para entender cómo funcionan las variables locales estáticas en C.<!--more--></p>

<p><em>Nota: todo el código en este post fue compilado en una CPU x86_64 corriendo Mac OS X 10.8.1, usando Clang 4.0 con las optimizaciones deshabilitadas (<code>-O0</code>)<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>.</em></p>

<h2>Aprendiendo assembler con GDB</h2>

<p>Empecemos por desensamblar un programa con GDB y aprender a leer su salida. Tipeá el siguiente programa en un archivo de texto y grabalo como <code>simple.c</code>:</p>

<figure class='code'><figcaption><span>sample.c </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">6</span><span class="p">;</span>
</span><span class='line'>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ahora compilalo con los símbolos de depuración y sin optimizaciones, y corré GDB<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup>:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ CFLAGS</span><span class="o">=</span><span class="s2">&quot;-g -O0&quot;</span> make simple
</span><span class='line'>cc -g -O0    simple.c   -o simple
</span><span class='line'><span class="nv">$ </span>gdb simple
</span></code></pre></td></tr></table></div></figure>


<p>Dentro de GDB, pongamos un breakpoint en <code>main</code> y ejecutemos hasta llegar al <code>return</code>. Ponemos el número 2 después de <code>next</code> para especificar que queremos ejecutar el comando <code>next</code> dos veces:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c-objdump'><span class='line'><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="k">break</span> <span class="n">main</span>
</span><span class='line'><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">run</span>
</span><span class='line'><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">next</span> <span class="mi">2</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ahora usemos el comando <code>disassemble</code> para mostrar las instrucciones assembler de la función actual. También podés pasarle el nombre de una función a <code>disassemble</code> para examinar una función diferente.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='c-objdump'><span class='line'><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">disassemble</span>
</span><span class='line'><span class="n">Dump</span> <span class="n">of</span> <span class="n">assembler</span> <span class="n">code</span> <span class="k">for</span> <span class="n">function</span> <span class="n">main</span><span class="o">:</span>
</span><span class='line'><span class="mh">0x0000000100000f50</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">0</span><span class="o">&gt;:</span>    <span class="n">push</span>   <span class="o">%</span><span class="n">rbp</span>
</span><span class='line'><span class="mh">0x0000000100000f51</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">1</span><span class="o">&gt;:</span>    <span class="n">mov</span>    <span class="o">%</span><span class="n">rsp</span><span class="p">,</span><span class="o">%</span><span class="n">rbp</span>
</span><span class='line'><span class="mh">0x0000000100000f54</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">4</span><span class="o">&gt;:</span>    <span class="n">mov</span>    <span class="err">$</span><span class="mh">0x0</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>
</span><span class='line'><span class="mh">0x0000000100000f59</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">9</span><span class="o">&gt;:</span>    <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x0</span><span class="p">,</span><span class="o">-</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">rbp</span><span class="p">)</span>
</span><span class='line'><span class="mh">0x0000000100000f60</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">16</span><span class="o">&gt;:</span>   <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x5</span><span class="p">,</span><span class="o">-</span><span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">rbp</span><span class="p">)</span>
</span><span class='line'><span class="mh">0x0000000100000f67</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">23</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">-</span><span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">rbp</span><span class="p">),</span><span class="o">%</span><span class="n">ecx</span>
</span><span class='line'><span class="mh">0x0000000100000f6a</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">26</span><span class="o">&gt;:</span>   <span class="n">add</span>    <span class="err">$</span><span class="mh">0x6</span><span class="p">,</span><span class="o">%</span><span class="n">ecx</span>
</span><span class='line'><span class="mh">0x0000000100000f70</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">32</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">ecx</span><span class="p">,</span><span class="o">-</span><span class="mh">0xc</span><span class="p">(</span><span class="o">%</span><span class="n">rbp</span><span class="p">)</span>
</span><span class='line'><span class="mh">0x0000000100000f73</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">35</span><span class="o">&gt;:</span>   <span class="n">pop</span>    <span class="o">%</span><span class="n">rbp</span>
</span><span class='line'><span class="mh">0x0000000100000f74</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">36</span><span class="o">&gt;:</span>   <span class="n">retq</span>
</span><span class='line'><span class="n">End</span> <span class="n">of</span> <span class="n">assembler</span> <span class="n">dump</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>El comando <code>disassemble</code> defaultea a mostrar las instrucciones en la sintaxis de AT&amp;T, que es la misma sintaxis usada por el assembler de GNU<sup id="fnref:3"><a href="#fn:3" rel="footnote">3</a></sup>. Las instrucciones en la sintaxis AT&amp;T son del formato <code>mnemónico origen, destino</code>. El mnemónico es el nombre <em>humanamente legible</em><sup id="fnref:4"><a href="#fn:4" rel="footnote">4</a></sup> de la instrucción. <code>origen</code> y <code>destino</code> son operandos, que pueden ser valores inmediatos, registros, direcciones de memoria o etiquetas. Los valores inmediatos son constantes, y están prefijados por un <code>$</code>. Por ejemplo, <code>$0x5</code> representa al número 5 en hexadecimal. Los nombres de registros están prefijados por un <code>%</code>.</p>

<h3>Registros</h3>

<p>Vale la pena dedicarle un ratito a entender los registros. Los registros son porciones de almacenamiento de datos que se encuentran directamente en el CPU. Salvo algunas excepciones, el tamaño, o <em>ancho</em>, de los registros de una CPU definen su arquitectura. Entonces, si tenés una CPU de 64 bits, tus registros van a medir 64 bits. Lo mismo ocurre con las CPUs de 32 bits (registros de 32 bits), 16 bits, y así<sup id="fnref:5"><a href="#fn:5" rel="footnote">5</a></sup>. Los registros son de muy rápido acceso, y en general son los operandos de las operaciones aritméticas y lógicas.</p>

<p>La familia x86 tiene registros de propósito general y de propósito específico. Los de propósito general pueden usarse para cualquier operación, y su valor no tiene un significado especial para la CPU. En cambio, la CPU depende de ciertos registros de propósito específico para su propia operación, y los valores que en ellos se almacenan tienen un significado especial según el registro de que se trate. En nuestro ejemplo anterior, <code>%eax</code> y <code>%ecx</code> son registros de propósito general, mientras que <code>%rbp</code> y <code>%rsp</code> son de propósito específico. <code>%rbp</code> es el <em>base pointer</em> (puntero base), que apunta a la base del marco actual dentro del stack (<em>current stack frame</em>), y <code>%rsp</code> es el <em>stack pointer</em> (puntero al stack), que apunta al tope del stack frame actual. <code>%rbp</code> siempre tiene un valor mayor a <code>%rsp</code> porque el stack comienza en una dirección de memoria alta y crece hacia abajo. Si no te es muy familiar el concepto de stack de llamadas, podés encontrar <a href="http://en.wikipedia.org/wiki/Call_stack">una buena introducción en Wikipedia</a> (y <a href="http://es.wikipedia.org/wiki/Pila_de_llamadas">acá en español</a>).</p>

<p>Un detalle de la familia x86 es que mantuvo compatibilidad hacia atrás desde el procesador 8086, de 16 bits. A medida que el x86 avanzó de 16 bits a 32, y de 32 a 64, los registros se expandieron y fueron tomando nuevos nombres, de modo de no romper la compatibilidad con código escrito para CPUs anteriores, menos anchos.</p>

<p>Tomemos de ejemplo al registro <code>AX</code> de propósito general, de 16 bits. El byte <em>alto</em> puede accederse con el nombre <code>AH</code> (<em>A High</em>), y el bajo con <code>AL</code> (<em>A Low</em>). Cuando salió el 80386, de 32 bits, el registro AX Extendido (<em>Extended AX</em>, <code>EAX</code>) refirió al registro de 32 bits, mientras que <code>AX</code> se siguió refiriendo al registro formado por los 16 bits de la mitad baja del <code>EAX</code>. Del mismo modo, al salir la arquitectura x86_64, se usó el prefijo <code>R</code>, y el <code>EAX</code> pasó a ser la mitad baja del registro <code>RAX</code>, de 64 bits. Este es un diagrama basado en un <a href="http://en.wikipedia.org/wiki/X86#x86_registers">artículo de Wikipedia</a> para visualizar estas relaciones:</p>

<figure class='code'><figcaption><span>Subdivisiones de los registros en x86_64 </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>|__64__|__56__|__48__|__40__|__32__|__24__|__16__|__8___|
</span><span class='line'>|__________________________RAX__________________________|
</span><span class='line'>|xxxxxxxxxxxxxxxxxxxxxxxxxxx|____________EAX____________|
</span><span class='line'>|xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx|_____AX______|
</span><span class='line'>|xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx|__AH__|__AL__|</span></code></pre></td></tr></table></div></figure>


<h3>Volviendo al código</h3>

<p>Ya deberíamos tener información suficiente para entender nuestro programa desensamblado:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c-objdump'><span class='line'><span class="mh">0x0000000100000f50</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">0</span><span class="o">&gt;:</span>    <span class="n">push</span>   <span class="o">%</span><span class="n">rbp</span>
</span><span class='line'><span class="mh">0x0000000100000f51</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">1</span><span class="o">&gt;:</span>    <span class="n">mov</span>    <span class="o">%</span><span class="n">rsp</span><span class="p">,</span><span class="o">%</span><span class="n">rbp</span>
</span></code></pre></td></tr></table></div></figure>


<p>Las primeras dos instrucciones se llaman el <em>prólogo</em> o <em>preámbulo</em> de una función. Primero <code>push</code>eamos el antiguo base pointer al stack para guardarlo para más tarde. Después copiamos el valor del stack pointer al base pointer. Después de esto, <code>%rbp</code> apunta a la base del stack frame de <code>main</code>.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c-objdump'><span class='line'><span class="mh">0x0000000100000f54</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">4</span><span class="o">&gt;:</span>    <span class="n">mov</span>    <span class="err">$</span><span class="mh">0x0</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>
</span></code></pre></td></tr></table></div></figure>


<p>Esta instrucción copia un 0 a <code>%eax</code>. La convención de llamadas (<em>calling convention</em>) del x86 dice que el valor de retorno de una función debe almacenarse en <code>%eax</code>, de modo que esta instrucción prepara el <code>return 0</code> al final de nuestra función.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c-objdump'><span class='line'><span class="mh">0x0000000100000f59</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">9</span><span class="o">&gt;:</span>    <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x0</span><span class="p">,</span><span class="o">-</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">rbp</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Acá vemos algo que no habíamos visto antes: <code>-0x4(%rbp)</code>. Los paréntesis nos indican que eso es una dirección de memoria. En este caso, <code>%rbp</code> es el registro base, y <code>-0x4</code> es el desplazamiento. Esto es equivalente a <code>%rbp + -0x4</code>. Como el stack crece hacia abajo, restarle 4 a la base del stack frame actual nos mueve dentro del frame mismo, donde se almacenan las variables locales. Esto significa que esta instrucción almacena un 0 en <code>%rbp - 4</code>. Me llevó un rato entender para qué era esta línea, pero parece que clang <a href="http://lists.cs.uiuc.edu/pipermail/cfe-dev/2012-February/019767.html">reserva una variable local oculta</a> para un valor de retorno implícito de <code>main</code>.</p>

<p>También habrás notado que el mnemónico tiene el sufijo <code>l</code>. Esto significa que los operandos van a ser de tipo <code>l</code>ong (32 bits, para los enteros). Otros sufijos válidos son <code>b</code>yte, <code>s</code>hort, <code>q</code>uad y <code>t</code>en. Si ves una instrucción que no tiene un sufijo, el tamaño de los operandos se infiere de los tamaños de los registros origen y destino. Por ejemplo, en la línea anterior, <code>%eax</code> mide 32 bits, por lo que la instrucción <code>mov</code> se infiere a <code>movl</code>.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c-objdump'><span class='line'><span class="mh">0x0000000100000f60</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">16</span><span class="o">&gt;:</span>   <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x5</span><span class="p">,</span><span class="o">-</span><span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">rbp</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>¡Ahora estamos llegando a la papa de nuestro programa! Esta primer línea de assembler es la primera línea de C en <code>main</code>, y almacena el número 5 en el espacio de la próxima variable local (<code>%rbp - 0x8</code>), 4 bytes debajo de nuestra última variable local. Esa es la posición de <code>a</code>. Podemos usar GDB para verificarlo:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c-objdump'><span class='line'><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span> <span class="o">&amp;</span><span class="n">a</span>
</span><span class='line'><span class="mh">0x7fff5fbff768</span><span class="o">:</span> <span class="mh">0x00000005</span>
</span><span class='line'><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span> <span class="err">$</span><span class="n">rbp</span> <span class="o">-</span> <span class="mi">8</span>
</span><span class='line'><span class="mh">0x7fff5fbff768</span><span class="o">:</span> <span class="mh">0x00000005</span>
</span></code></pre></td></tr></table></div></figure>


<p>Fijate que las direcciones de memoria son las mismas. Vas a notar que GDB tiene variables que representan nuestros registros, pero como todas las variables en GDB, las prefijamos con <code>$</code> en vez del <code>%</code> usado en el assembler de AT&amp;T.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c-objdump'><span class='line'><span class="mh">0x0000000100000f67</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">23</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">-</span><span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">rbp</span><span class="p">),</span><span class="o">%</span><span class="n">ecx</span>
</span><span class='line'><span class="mh">0x0000000100000f6a</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">26</span><span class="o">&gt;:</span>   <span class="n">add</span>    <span class="err">$</span><span class="mh">0x6</span><span class="p">,</span><span class="o">%</span><span class="n">ecx</span>
</span><span class='line'><span class="mh">0x0000000100000f70</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">32</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">ecx</span><span class="p">,</span><span class="o">-</span><span class="mh">0xc</span><span class="p">(</span><span class="o">%</span><span class="n">rbp</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Entonces movemos (<code>mov</code>) <code>a</code> a <code>%ecx</code>, uno de nuestros registros de propósito general, le sumamos (<code>add</code>) 6, y almacenamos el resultado en <code>%rbp - 0xc</code>. Esta es la segunda línea de C en <code>main</code>. Quizá te diste cuenta que <code>%rbp - 0xc</code> es <code>b</code>, cosa que podemos verificar en GDB:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c-objdump'><span class='line'><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span> <span class="o">&amp;</span><span class="n">b</span>
</span><span class='line'><span class="mh">0x7fff5fbff764</span><span class="o">:</span> <span class="mh">0x0000000b</span>
</span><span class='line'><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span> <span class="err">$</span><span class="n">rbp</span> <span class="o">-</span> <span class="mh">0xc</span>
</span><span class='line'><span class="mh">0x7fff5fbff764</span><span class="o">:</span> <span class="mh">0x0000000b</span>
</span></code></pre></td></tr></table></div></figure>


<p>El resto de <code>main</code> es simplemente limpieza, llamado el <em>epílogo</em> de la función:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c-objdump'><span class='line'><span class="mh">0x0000000100000f73</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">35</span><span class="o">&gt;:</span>   <span class="n">pop</span>    <span class="o">%</span><span class="n">rbp</span>
</span><span class='line'><span class="mh">0x0000000100000f74</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">36</span><span class="o">&gt;:</span>   <span class="n">retq</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>pop</code>eamos el viejo base pointer del stack y lo devolvemos al <code>%rbp</code>, y luego <code>retq</code> nos devuelve a nuestra dirección de retorno, que también está almacenada en el stack frame.</p>

<p>Hasta ahora, usamos GDB para desensamblar un pequeño programa C, le pegamos un vistazo a cómo leer la sintaxis de assembler de AT&amp;T, y hablamos un poco de los operandos de registros y direcciones de memoria. También usamos GDB para verificar dónde se almacenan nuestras variables locales en relación a <code>%rbp</code>. Ahora vamos a ver cómo usar nuestras nuevas habilidades para explicar cómo funcionan las variables locales estáticas.</p>

<h2>Entendiendo las variables estáticas locales</h2>

<p>Las variables estáticas locales son una característica muy copada de C. En dos palabras, son variables locales que se inicializan una única vez y persisten sus valores a través de las sucesivas llamadas a la función en que fueron definidas. Un caso de uso bastante simple de las variables estáticas locales es un generador <em>à la</em> Python. Este ejemplo genera todos los números naturales hasta <code>INT_MAX</code>:</p>

<figure class='code'><figcaption><span>static.c </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/* static.c */</span>
</span><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="kt">int</span> <span class="nf">natural_generator</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>  <span class="k">static</span> <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>  <span class="n">b</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">natural_generator</span><span class="p">());</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">natural_generator</span><span class="p">());</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">natural_generator</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Cuando lo compilamos y ejecutamos, este programa imprime los primeros tres números naturales:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ CFLAGS</span><span class="o">=</span><span class="s2">&quot;-g -O0&quot;</span> make static
</span><span class='line'>cc -g -O0    static.c   -o static
</span><span class='line'><span class="nv">$ </span>./static
</span><span class='line'>1
</span><span class='line'>2
</span><span class='line'>3
</span></code></pre></td></tr></table></div></figure>


<p>Pero, ¿cómo funciona esto? Para entender las estáticas locales, vamos a meternos en GDB y mirar el assembler. Saqué las direcciones que muestra GDB al desensamblado para que entre en la pantalla:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='c-objdump'><span class='line'><span class="err">$</span> <span class="n">gdb</span> <span class="k">static</span>
</span><span class='line'><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="k">break</span> <span class="n">natural_generator</span>
</span><span class='line'><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">run</span>
</span><span class='line'><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">disassemble</span>
</span><span class='line'><span class="n">Dump</span> <span class="n">of</span> <span class="n">assembler</span> <span class="n">code</span> <span class="k">for</span> <span class="n">function</span> <span class="n">natural_generator</span><span class="o">:</span>
</span><span class='line'><span class="n">push</span>   <span class="o">%</span><span class="n">rbp</span>
</span><span class='line'><span class="n">mov</span>    <span class="o">%</span><span class="n">rsp</span><span class="p">,</span><span class="o">%</span><span class="n">rbp</span>
</span><span class='line'><span class="n">movl</span>   <span class="err">$</span><span class="mh">0x1</span><span class="p">,</span><span class="o">-</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">rbp</span><span class="p">)</span>
</span><span class='line'><span class="n">mov</span>    <span class="mh">0x177</span><span class="p">(</span><span class="o">%</span><span class="n">rip</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>        <span class="err">#</span> <span class="mh">0x100001018</span> <span class="o">&lt;</span><span class="n">natural_generator</span><span class="p">.</span><span class="n">b</span><span class="o">&gt;</span>
</span><span class='line'><span class="n">add</span>    <span class="err">$</span><span class="mh">0x1</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>
</span><span class='line'><span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="mh">0x16c</span><span class="p">(</span><span class="o">%</span><span class="n">rip</span><span class="p">)</span>        <span class="err">#</span> <span class="mh">0x100001018</span> <span class="o">&lt;</span><span class="n">natural_generator</span><span class="p">.</span><span class="n">b</span><span class="o">&gt;</span>
</span><span class='line'><span class="n">mov</span>    <span class="o">-</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">rbp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
</span><span class='line'><span class="n">add</span>    <span class="mh">0x163</span><span class="p">(</span><span class="o">%</span><span class="n">rip</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>        <span class="err">#</span> <span class="mh">0x100001018</span> <span class="o">&lt;</span><span class="n">natural_generator</span><span class="p">.</span><span class="n">b</span><span class="o">&gt;</span>
</span><span class='line'><span class="n">pop</span>    <span class="o">%</span><span class="n">rbp</span>
</span><span class='line'><span class="n">retq</span>
</span><span class='line'><span class="n">End</span> <span class="n">of</span> <span class="n">assembler</span> <span class="n">dump</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>Lo primero que necesitamos descubrir es en qué instrucción estamos. Podemos hacer eso examinando el &ldquo;instruction pointer&rdquo; (<em>puntero de instrucción</em>) o &ldquo;program counter&rdquo; (<em>contador de programa</em>). El instruction pointer es un registro que almacena la dirección de memoria de la próxima instrucción. En x86_64, ese registro es <code>%rip</code>. Podemos acceder al instruction pointer usando la variable <code>$rip</code>, o podemos usar <code>$pc</code>, la alternativa independiente de la plataforma:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c-objdump'><span class='line'><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="n">i</span> <span class="err">$</span><span class="n">pc</span>
</span><span class='line'><span class="mh">0x100000e94</span> <span class="o">&lt;</span><span class="n">natural_generator</span><span class="o">+</span><span class="mi">4</span><span class="o">&gt;:</span>  <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x1</span><span class="p">,</span><span class="o">-</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">rbp</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>El instruction pointer siempre contiene la dirección de la <em>próxima</em> instrucción a ejecutar, lo que significa que la tercer instrucción aún no se ejecutó, pero está a punto.</p>

<p>Como es bastante útil conocer la próxima instrucción, vamos a hacer que GDB nos muestre la próxima instrucción cada vez que frenamos el programa. A partir de GDB 7.0, podés ejecutar <code>set disassemble-next-line on</code>, que muestra todas las instrucciones que conforman la próxima instrucción fuente, pero estamos usando Mac OS X, que trae GDB 6.3, así que vamos a tener que recurrir al comando <code>display</code>. <code>display</code> es como <code>x</code>, sólo que evalúa la expresión cada vez que nuestro programa se detiene:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c-objdump'><span class='line'><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">display</span><span class="o">/</span><span class="n">i</span> <span class="err">$</span><span class="n">pc</span>
</span><span class='line'><span class="mi">1</span><span class="o">:</span> <span class="n">x</span><span class="o">/</span><span class="n">i</span> <span class="err">$</span><span class="n">pc</span>  <span class="mh">0x100000e94</span> <span class="o">&lt;</span><span class="n">natural_generator</span><span class="o">+</span><span class="mi">4</span><span class="o">&gt;:</span>  <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x1</span><span class="p">,</span><span class="o">-</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">rbp</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ahora GDB está listo para mostrarnos siempre la próxima instrucción a ejecutar antes del prompt.</p>

<p>Ya pasamos el prólogo de la función, del que hablamos antes, así que vamos a empezar en la tercer instrucción. Esto corresponde a la primer línea de código que asigna 1 a <code>a</code>. En lugar de <code>next</code>, que nos mueve a la próxima instrucción fuente, vamos a usar <code>nexti</code>, que nos mueve a la próxima instrucción assembler. Después, vamos a examinar <code>%rbp - 0x4</code> para verificar nuestra hipótesis de que <code>a</code> se almacena en <code>%rbp - 0x4</code>.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c-objdump'><span class='line'><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">nexti</span>
</span><span class='line'><span class="mi">7</span>           <span class="n">b</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="mi">1</span><span class="o">:</span> <span class="n">x</span><span class="o">/</span><span class="n">i</span> <span class="err">$</span><span class="n">pc</span>  <span class="n">mov</span>   <span class="mh">0x177</span><span class="p">(</span><span class="o">%</span><span class="n">rip</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span> <span class="err">#</span> <span class="mh">0x100001018</span> <span class="o">&lt;</span><span class="n">natural_generator</span><span class="p">.</span><span class="n">b</span><span class="o">&gt;</span>
</span><span class='line'><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span> <span class="err">$</span><span class="n">rbp</span> <span class="o">-</span> <span class="mh">0x4</span>
</span><span class='line'><span class="mh">0x7fff5fbff78c</span><span class="o">:</span> <span class="mh">0x00000001</span>
</span><span class='line'><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span> <span class="o">&amp;</span><span class="n">a</span>
</span><span class='line'><span class="mh">0x7fff5fbff78c</span><span class="o">:</span> <span class="mh">0x00000001</span>
</span></code></pre></td></tr></table></div></figure>


<p>Son lo mismo, tal como esperábamos. La próxima instrucción es más interesante:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c-objdump'><span class='line'><span class="n">mov</span>    <span class="mh">0x177</span><span class="p">(</span><span class="o">%</span><span class="n">rip</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>        <span class="err">#</span> <span class="mh">0x100001018</span> <span class="o">&lt;</span><span class="n">natural_generator</span><span class="p">.</span><span class="n">b</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Acá es donde esperaríamos encontrar la línea <code>static int b = -1;</code>, pero se ve substancialmente distinta de cualquier otra cosa que hayamos visto antes. Por empezar, no hay referencia al stack frame, donde esperaríamos encontrar las variables locales. ¡Ni siquiera hay un <code>-0x1</code>! En cambio, tenemos una instrucción que carga <code>0x100001018</code>, ubicada en algún lugar después del instruction pointer, a <code>%eax</code>. GDB nos da un comentario bastante útil con el resultado del cálculo del operando en memoria, y nos da una pista diciéndonos que <code>natural_generator.b</code> se encuentra en esa dirección. Corramos esta instrucción y veamos qué pasa:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c-objdump'><span class='line'><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">nexti</span>
</span><span class='line'><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">p</span> <span class="err">$</span><span class="n">rax</span>
</span><span class='line'><span class="err">$</span><span class="mi">3</span> <span class="o">=</span> <span class="mi">4294967295</span>
</span><span class='line'><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">p</span><span class="o">/</span><span class="n">x</span> <span class="err">$</span><span class="n">rax</span>
</span><span class='line'><span class="err">$</span><span class="mi">5</span> <span class="o">=</span> <span class="mh">0xffffffff</span>
</span></code></pre></td></tr></table></div></figure>


<p>Por más que el desensamblado muestre <code>%eax</code> como destino, nosotros imprimimos <code>$rax</code>, porque GDB sólo nos provee variables para los registros completos.</p>

<p>En este momento necesitamos recordar que, mientras que las variables tienen tipos que especifican si son signadas o no, los registros no, por lo que GDB imprime el valor de <code>%rax</code> sin signo. Probemos de nuevo, casteando <code>%rax</code> a un <code>int</code> signado:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c-objdump'><span class='line'><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">p</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="err">$</span><span class="n">rax</span>
</span><span class='line'><span class="err">$</span><span class="mi">11</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span></code></pre></td></tr></table></div></figure>


<p>Parece que encontramos a <code>b</code>. Podemos re-chequear esto usando el comando <code>x</code>:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c-objdump'><span class='line'><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="n">d</span> <span class="mh">0x100001018</span>
</span><span class='line'><span class="mh">0x100001018</span> <span class="o">&lt;</span><span class="n">natural_generator</span><span class="p">.</span><span class="n">b</span><span class="o">&gt;:</span>  <span class="o">-</span><span class="mi">1</span>
</span><span class='line'><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="n">d</span> <span class="o">&amp;</span><span class="n">b</span>
</span><span class='line'><span class="mh">0x100001018</span> <span class="o">&lt;</span><span class="n">natural_generator</span><span class="p">.</span><span class="n">b</span><span class="o">&gt;:</span>  <span class="o">-</span><span class="mi">1</span>
</span></code></pre></td></tr></table></div></figure>


<p>Entonces, no es sólo que <code>b</code> está en una dirección de memoria baja, fuera del stack, si no que además se la inicializa a -1 antes de que se llame a <code>natural_generator</code>. De hecho, incluso si desensamblaras el programa completo, no encontrarías ningún código que setteara <code>b</code> a -1. Esto ocurre porque el valor de <code>b</code> se hardcodea en otra sección del ejecutable <code>sample</code>, y el loader del sistema operativo lo carga en memoria junto con todo el código de máquina cuando se lanza el proceso<sup id="fnref:6"><a href="#fn:6" rel="footnote">6</a></sup>.</p>

<p>Después de todo esto, las cosas empiezan a tener más sentido. Tras almacenar <code>b</code> en <code>%eax</code>, pasamos a la próxima instrucción fuente, en la que incrementamos <code>b</code>. Esto se corresponde a las próximas dos instrucciones:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c-objdump'><span class='line'><span class="n">add</span>    <span class="err">$</span><span class="mh">0x1</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>
</span><span class='line'><span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="mh">0x16c</span><span class="p">(</span><span class="o">%</span><span class="n">rip</span><span class="p">)</span>        <span class="err">#</span> <span class="mh">0x100001018</span> <span class="o">&lt;</span><span class="n">natural_generator</span><span class="p">.</span><span class="n">b</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Acá le agregamos (<code>add</code>) 1 a <code>%eax</code>, y almacenamos el resultado en la memoria. Corramos estas instrucciones y verifiquemos el resultado:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c-objdump'><span class='line'><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">nexti</span> <span class="mi">2</span>
</span><span class='line'><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="n">d</span> <span class="o">&amp;</span><span class="n">b</span>
</span><span class='line'><span class="mh">0x100001018</span> <span class="o">&lt;</span><span class="n">natural_generator</span><span class="p">.</span><span class="n">b</span><span class="o">&gt;:</span>  <span class="mi">0</span>
</span><span class='line'><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">p</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="err">$</span><span class="n">rax</span>
</span><span class='line'><span class="err">$</span><span class="mi">15</span> <span class="o">=</span> <span class="mi">0</span>
</span></code></pre></td></tr></table></div></figure>


<p>Las próximas dos instrucciones nos preparan para devolver <code>a + b</code>:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c-objdump'><span class='line'><span class="n">mov</span>    <span class="o">-</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">rbp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
</span><span class='line'><span class="n">add</span>    <span class="mh">0x163</span><span class="p">(</span><span class="o">%</span><span class="n">rip</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>        <span class="err">#</span> <span class="mh">0x100001018</span> <span class="o">&lt;</span><span class="n">natural_generator</span><span class="p">.</span><span class="n">b</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Acá cargamos <code>a</code> en <code>%eax</code>, y luego le sumamos <code>b</code>. En este punto, esperaríamos que <code>%eax</code> valga 1. Verifiquemos:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c-objdump'><span class='line'><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">nexti</span> <span class="mi">2</span>
</span><span class='line'><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">p</span> <span class="err">$</span><span class="n">rax</span>
</span><span class='line'><span class="err">$</span><span class="mi">16</span> <span class="o">=</span> <span class="mi">1</span>
</span></code></pre></td></tr></table></div></figure>


<p>Se usa <code>%eax</code> para almacenar el valor de retorno de <code>natural_generator</code>, así que estamos listos para el epílogo, que limpia el stack y retorna:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c-objdump'><span class='line'><span class="n">pop</span>    <span class="o">%</span><span class="n">rbp</span>
</span><span class='line'><span class="n">retq</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ahora que entendemos cómo se inicializa <code>b</code>, veamos qué pasa cuando corremos <code>natural_generator</code> otra vez:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c-objdump'><span class='line'><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="k">continue</span>
</span><span class='line'><span class="n">Continuing</span><span class="p">.</span>
</span><span class='line'><span class="mi">1</span>
</span><span class='line'>
</span><span class='line'><span class="n">Breakpoint</span> <span class="mi">1</span><span class="p">,</span> <span class="n">natural_generator</span> <span class="p">()</span> <span class="n">at</span> <span class="k">static</span><span class="p">.</span><span class="n">c</span><span class="o">:</span><span class="mi">5</span>
</span><span class='line'><span class="mi">5</span>           <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="mi">1</span><span class="o">:</span> <span class="n">x</span><span class="o">/</span><span class="n">i</span> <span class="err">$</span><span class="n">pc</span>  <span class="mh">0x100000e94</span> <span class="o">&lt;</span><span class="n">natural_generator</span><span class="o">+</span><span class="mi">4</span><span class="o">&gt;:</span>  <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x1</span><span class="p">,</span><span class="o">-</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">rbp</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span> <span class="o">&amp;</span><span class="n">b</span>
</span><span class='line'><span class="mh">0x100001018</span> <span class="o">&lt;</span><span class="n">natural_generator</span><span class="p">.</span><span class="n">b</span><span class="o">&gt;:</span>  <span class="mi">0</span>
</span></code></pre></td></tr></table></div></figure>


<p>Como <code>b</code> no está almacenada en el stack junto con las otras variables locales, al volver a llamar a <code>natural_generator</code> sigue valiendo 0. No importa cuántas veces llamemos a nuestro generador, <code>b</code> siempre va a retener su valor. Esto ocurre porque está almacenada fuera del stack, y es inicializada cuando el loader mueve el programa a memoria en lugar de por nuestor código máquina.</p>

<h2>Conclusión</h2>

<p>Comenzamos viendo cómo leer assembler y cómo desensamblar un programa con GDB. Luego, vimos cómo funcionan las variables estáticas locales, cosa que no podríamos haber hecho sin desensamblar nuestro ejecutable.</p>

<p>Pasamos mucho tiempo alternando entre leer instrucciones assembler y verificando nuestras hipótesis en GDB. Puede parecer repetitivo, pero hay una razón muy importante para hacerlo así: la mejor manera de aprender algo abstracto es volverlo más concreto, y una de las mejores maneras de hacer más concreto a algo es usando herramientas que te dejen sacarle capas de abstracción. La mejor manera de aprender estas herramientas es forzándote a usarlas hasta que te sean naturales.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p><strong>NdeT</strong>: Lo de que es en OS X no es porque me haga el careta usando Mac, si no porque el post original estaba así, y todavía no tengo la sopa/tiempo/ganas de hacer todo lo mismo pero en Linux con <code>gcc</code> :)<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p>Tal vez notes que usamos Make para buildear <code>simple.c</code> sin un makefile. Podemos hacerlo porque Make tiene reglas implícitas para buildear ejecutables a partir de archivos C. Podés encontrar más información sobre esas reglas en el <a href="http://www.gnu.org/software/make/manual/make.html#Implicit-Rules">manual de Make</a><a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
<li id="fn:3">
<p>También podés hacer que GDB muestre la sintaxis de Intel, usada por NASM, MASM y otros assemblers, pero eso se va del alcance del post.<a href="#fnref:3" rev="footnote">&#8617;</a></p></li>
<li id="fn:4">
<p><strong>NdeT</strong>: Con <em>humanamente legible</em> quiere decir <em><strong>Joaco</strong>-humanamente legible</em>, pero bue&hellip;<a href="#fnref:4" rev="footnote">&#8617;</a></p></li>
<li id="fn:5">
<p>Los procesadores con sets de instrucciones SIMD (como MMX y SSE para x86, y AltiVec para PowerPC) suelen tener algunos registros que son más anchos que la arquitectura de la CPU.<a href="#fnref:5" rev="footnote">&#8617;</a></p></li>
<li id="fn:6">
<p>Reservamos para un post futuro la discusión sobre formatos de objeto, loaders y linkers.<a href="#fnref:6" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">mgarciaisaia</span></span>

      








  


<time datetime="2015-02-19T19:10:00-03:00" pubdate data-updated="true">Feb 19<span>th</span>, 2015</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="/tutorial-c//twitter.com/share" class="twitter-share-button" data-url="http://mgarciaisaia.github.io/tutorial-c/blog/2015/02/19/aprendiendo-assembler-para-entender-c/" data-via="" data-counturl="http://mgarciaisaia.github.io/tutorial-c/blog/2015/02/19/aprendiendo-assembler-para-entender-c/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="small"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/tutorial-c/blog/2015/02/07/between-a-rock-and-a-hard-link/" title="Previous Post: Between a rock and a hard link">&laquo; Between a rock and a hard link</a>
      
      
        <a class="basic-alignment right" href="/tutorial-c/blog/2015/02/24/aprendiendo-c-con-gdb/" title="Next Post: Aprendiendo C con GDB">Aprendiendo C con GDB &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Acerca de...</h1>
  <p>Pequeña introducción a C y otras herramientas necesarias para desarrollar el TP de Sistemas Operativos de la UTN FRBA</p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/tutorial-c/blog/2015/02/27/dream-of-serialization/">Dream of Serialization</a>
      </li>
    
      <li class="post">
        <a href="/tutorial-c/blog/2015/02/24/aprendiendo-c-con-gdb/">Aprendiendo C Con GDB</a>
      </li>
    
      <li class="post">
        <a href="/tutorial-c/blog/2015/02/19/aprendiendo-assembler-para-entender-c/">Aprendiendo Assembler Para Entender C</a>
      </li>
    
      <li class="post">
        <a href="/tutorial-c/blog/2015/02/07/between-a-rock-and-a-hard-link/">Between a Rock and a Hard Link</a>
      </li>
    
      <li class="post">
        <a href="/tutorial-c/blog/2014/12/26/int-vs-int32-t/">Int vs Int32_t</a>
      </li>
    
      <li class="post">
        <a href="/tutorial-c/blog/2014/12/26/compiladores-y-errores/">Compiladores Y Errores</a>
      </li>
    
      <li class="post">
        <a href="/tutorial-c/blog/2014/12/26/un-tutorial-rapido-para-implementar-y-debuggear-malloc/">Un Tutorial Rápido Para Implementar Y Debuggear Malloc, Free, Calloc Y Realloc</a>
      </li>
    
      <li class="post">
        <a href="/tutorial-c/blog/2014/09/04/p-sherman-calle-wallaby-42-sydney/">P. Sherman, Calle Wallaby 42, Sydney</a>
      </li>
    
      <li class="post">
        <a href="/tutorial-c/blog/2014/03/20/she-bangs-she-bangs/">She Bangs, She Bangs...</a>
      </li>
    
      <li class="post">
        <a href="/tutorial-c/blog/2013/12/31/me-di-cuenta-que-me-tiraste-la-senal/">Me Dí Cuenta Que Me Tiraste La Señal</a>
      </li>
    
      <li class="post">
        <a href="/tutorial-c/blog/2013/12/30/inotify/">Inotify</a>
      </li>
    
      <li class="post">
        <a href="/tutorial-c/blog/2013/10/21/bajando-el-nivel/">Bajando El Nivel</a>
      </li>
    
      <li class="post">
        <a href="/tutorial-c/blog/2013/08/20/variables/">Variables</a>
      </li>
    
      <li class="post">
        <a href="/tutorial-c/blog/2013/08/19/arrancando/">Arrancando</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/sisoputnfrba">@sisoputnfrba</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'sisoputnfrba',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/tutorial-c/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - mgarciaisaia -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'tutorialc';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://mgarciaisaia.github.io/tutorial-c/blog/2015/02/19/aprendiendo-assembler-para-entender-c/';
        var disqus_url = 'http://mgarciaisaia.github.io/tutorial-c/blog/2015/02/19/aprendiendo-assembler-para-entender-c/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
